     1                                  ; hello-os
     2                                  ; TAB=4
     3                                  CYLS EQU 10
     4                                  
     5                                  		ORG		0x7c00			; このプログラムがどこに読み込まれるのか
     6                                  
     7                                  ; 以下は標準的なFAT12フォーマットフロッピーディスクのための記述
     8                                  
     9 00000000 EB4E                    		JMP		entry
    10 00000002 90                      		DB		0x90
    11 00000003 48454C4C4F49504C        		DB		"HELLOIPL"		; ブートセクタの名前を自由に書いてよい（8バイト）
    12 0000000B 0002                    		DW		512				; 1セクタの大きさ（512にしなければいけない）
    13 0000000D 01                      		DB		1				; クラスタの大きさ（1セクタにしなければいけない）
    14 0000000E 0100                    		DW		1				; FATがどこから始まるか（普通は1セクタ目からにする）
    15 00000010 02                      		DB		2				; FATの個数（2にしなければいけない）
    16 00000011 E000                    		DW		224				; ルートディレクトリ領域の大きさ（普通は224エントリにする）
    17 00000013 400B                    		DW		2880			; このドライブの大きさ（2880セクタにしなければいけない）
    18 00000015 F0                      		DB		0xf0			; メディアのタイプ（0xf0にしなければいけない）
    19 00000016 0900                    		DW		9				; FAT領域の長さ（9セクタにしなければいけない）
    20 00000018 1200                    		DW		18				; 1トラックにいくつのセクタがあるか（18にしなければいけない）
    21 0000001A 0200                    		DW		2				; ヘッドの数（2にしなければいけない）
    22 0000001C 00000000                		DD		0				; パーティションを使ってないのでここは必ず0
    23 00000020 400B0000                		DD		2880			; このドライブ大きさをもう一度書く
    24 00000024 000029                  		DB		0,0,0x29		; よくわからないけどこの値にしておくといいらしい
    25 00000027 FFFFFFFF                		DD		0xffffffff		; たぶんボリュームシリアル番号
    26 0000002B 48454C4C4F2D4F5320-     		DB		"HELLO-OS   "	; ディスクの名前（11バイト）
    26 00000034 2020               
    27 00000036 4641543132202020        		DB		"FAT12   "		; フォーマットの名前（8バイト）
    28 0000003E <res 00000012>          		RESB	18				; とりあえず18バイトあけておく
    28          ******************       warning: uninitialized space declared in .text section: zeroing
    29                                  
    30                                  ; プログラム本体
    31                                  
    32                                  entry:
    33 00000050 B80000                  		MOV		AX,0			; レジスタ初期化
    34 00000053 8ED0                    		MOV		SS,AX
    35 00000055 BC007C                  		MOV		SP,0x7c00
    36 00000058 8ED8                    		MOV		DS,AX
    37 0000005A 8EC0                    		MOV		ES,AX
    38                                  ;ディスクを読む
    39 0000005C B82008                  		MOV		AX,0x820
    40 0000005F 8EC0                    		MOV		ES,AX
    41 00000061 B500                    		MOV		CH,0			;シリンダ0
    42 00000063 B600                    		MOV		DH,0			;ヘッド0
    43 00000065 B102                    		MOV		CL,2			;セクタ2
    44                                  
    45                                  readloop:
    46 00000067 BE0000                  		MOV		SI,0
    47                                  retry:
    48 0000006A B402                    		MOV		AH,0x02			;AH=0x02 : ディスク読み込みに設定
    49 0000006C B001                    		MOV		AL,1			;1つ分のセクタを読む（AL:処理するセクタの数）
    50 0000006E BB0000                  		MOV		BX,0			;セグメントレジスタを設定する。
    51                                  								;メモリのES:BX番地のアドレスにディスク
    52                                  								;から読みだした内容を書き込む（このアドレスを
    53                                  								;バッファアドレスとよぶ)
    54                                  								;BXに0を指定すると、ES:BXのセグメントレジスタは0
    55                                  								;ということになり、0*16+ES=ES番地にディスクの内容が
    56                                  								;書き込まれる。
    57 00000071 B200                    		MOV		DL,0x00			; Aドライブ
    58 00000073 CD13                    		INT		0x13			; ディスクBIOS呼び出し
    59 00000075 7310                    		JNC		next
    60 00000077 83C601                  		ADD		SI,1
    61 0000007A 83FE05                  		CMP		SI,5
    62 0000007D 732D                    		JAE		error
    63 0000007F B400                    		MOV		AH,0x00			;AHレジスタ初期化 (システムのリセット1)
    64 00000081 B200                    		MOV		DL,0x00			;Aドライブ (システムのリセット2)
    65 00000083 CD13                    		INT		0x13			;ドライブのリセット (システムのリセット3)
    66 00000085 EBE3                    		JMP		retry
    67                                  next:
    68 00000087 8CC0                    		MOV		AX,ES
    69 00000089 83C020                  		ADD		AX,0x020
    70 0000008C 8EC0                    		MOV		ES,AX			;ADD ES,1ができないのでこうする
    71 0000008E 80C101                  		ADD		CL,1
    72 00000091 80F912                  		CMP		CL,18
    73 00000094 76D1                    		JBE		readloop
    74 00000096 B101                    		MOV		CL,1
    75 00000098 80C601                  		ADD		DH,1
    76 0000009B 80FE02                  		CMP		DH,2
    77 0000009E 72C7                    		JB 		readloop
    78 000000A0 B600                    		MOV		DH,0
    79 000000A2 80C501                  		ADD		CH,1
    80 000000A5 80FD0A                  		CMP		CH,CYLS
    81 000000A8 72BD                    		JB		readloop
    82 000000AA EB05                    		JMP 	success
    83                                  error:
    84 000000AC BE[DC00]                		MOV		SI,errormsg
    85 000000AF EB0B                    		JMP		putloop
    86                                  
    87                                  success:
    88 000000B1 E9(00C2)                		JMP 	0xc200
    89 000000B4 BE[CE00]                		MOV		SI,successmsg
    90 000000B7 EB03                    		JMP		putloop
    91                                  
    92                                  fin:
    93 000000B9 F4                      		HLT						; 何かあるまでCPUを停止させる
    94 000000BA EBFD                    		JMP		fin				; 無限ループ
    95                                  
    96                                  putloop:
    97 000000BC 8A04                    		MOV		AL,[SI]
    98 000000BE 83C601                  		ADD		SI,1			; SIに1を足す
    99 000000C1 3C00                    		CMP		AL,0
   100 000000C3 74F4                    		JE		fin
   101 000000C5 B40E                    		MOV		AH,0x0e			; 一文字表示ファンクション
   102 000000C7 BB0E00                  		MOV		BX,14			; カラーコード
   103 000000CA CD10                    		INT		0x10			; ビデオBIOS呼び出し
   104 000000CC EBEE                    		JMP		putloop
   105                                  
   106                                  successmsg:
   107 000000CE 0A0A                    		DB		0x0a, 0x0a		; 改行を2つ
   108 000000D0 5355434345535353        		DB		"SUCCESSS"
   109 000000D8 0A                      		DB		0x0a			; 改行
   110 000000D9 00                      		DB		0
   111                                  
   112 000000DA 55AA                    		DB		0x55, 0xaa
   113                                  
   114                                  errormsg:
   115 000000DC 0A0A                    		DB		0x0a, 0x0a		; 改行を2つ
   116 000000DE 4552524F52              		DB		"ERROR"
   117 000000E3 0A                      		DB		0x0a			; 改行
   118 000000E4 00                      		DB		0
   119                                  
   120 000000E5 <res 00000119>          		RESB	0x7dfe-($-$$)-0x7c00		; 0x7dfeまでを0x00で埋める命令
   120          ******************       warning: uninitialized space declared in .text section: zeroing
   121                                          ;0x7c00引くように変更(https://qiita.com/pollenjp/items/d15fce401bccd37e8059)
   122                                          ;おそらくQEMUのブートセクタの読み込まれるアドレスが0x7c00~でない
   123                                          ;EDKと合わせてメモリマップ取得->配置をやりたい
   124                                  
   125 000001FE 55AA                    		DB		0x55, 0xaa
